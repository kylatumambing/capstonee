rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }
    function isAdmin() {
      return isSignedIn() && request.auth.token.role == 'MHO';
    }
    function isBHW() {
      return isSignedIn() && request.auth.token.role == 'BHW';
    }
    function isBNS() {
      return isSignedIn() && request.auth.token.role == 'BNS';
    }

    // Users collection stores user profiles with role, barangay, sector
    match /users/{uid} {
      allow read: if isAdmin() || (isBHW() && request.auth.uid == uid) || (isBNS() && request.auth.uid == uid);
      allow write: if isAdmin();
    }

    // Children collection - top-level
    // Each child doc includes: name, birthDate, ageMonths, motherName, barangay, sector, bhwEmail, vaccines{}
    match /children/{childId} {
      allow create: if isAdmin() || isBHW();
      allow read: if isAdmin() || isBHW() || isBNS();
      allow update, delete: if isAdmin() || (isBHW() && resource.data.bhwEmail == request.auth.token.email);
    }

    // Aggregates, configs only admin
    match /configs/{doc} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
  }
}
